<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003" InitialTargets="RTK_SetDefaults">
    <PropertyGroup>
        <MSBuildAllProjects>$(MSBuildAllProjects);$(MSBuildThisFileFullPath)</MSBuildAllProjects>
        <OutputAssemblyName>Raid.Interop</OutputAssemblyName>
        <OutputAssemblyFile>$(OutputAssemblyName).dll</OutputAssemblyFile>
    </PropertyGroup>

    <ItemGroup>
        <AvailableItemName Include="RTKExtensionManifest">
            <Targets>GenerateRTKManifest</Targets>
        </AvailableItemName>
    </ItemGroup>

    <Import Project="Raid.Toolkit.Extensibility.Common.targets" />

    <UsingTask AssemblyFile="$(RaidToolkitSdkTasksPath)Raid.Toolkit.Extensibility.Tasks.dll" TaskName="Raid.Toolkit.Extensibility.Tasks.Codegen" Condition=" '$(RTKTasks)' != 'false' "/>

    <Target Name="RTK_SetDefaults" Condition=" '$(RTKTasks)' != 'false' ">
        <PropertyGroup>
            <GenerateInterop Condition=" '$(GenerateInterop)' == '' and '$(TargetExt)' != '.dll'">false</GenerateInterop>
            <!-- 
            <CoreCompileDependsOn>
                GenerateRTKInteropAssembly;
                $(CoreCompileDependsOn)
            </CoreCompileDependsOn> -->

            <ResolveAssemblyReferencesDependsOn>
                GenerateRTKInteropAssembly;
                $(ResolveAssemblyReferencesDependsOn)
            </ResolveAssemblyReferencesDependsOn>
        </PropertyGroup>
    </Target>

    <Target Name="GenerateRTKInteropAssembly" Condition=" '$(GenerateInterop)' == 'true' ">
        <MakeDir Directories="$(IntermediateOutputPath)" />
        <Raid.Toolkit.Extensibility.Tasks.Codegen OutputFile="$(IntermediateOutputPath)$(OutputAssemblyFile)" ManifestFiles="@(RTKExtensionManifest -> '%(FullPath)')" />
        <ItemGroup>
            <EmbeddedResource Include="@(RTKExtensionManifest)" LogicalName="PackageManifest" />
        </ItemGroup>
    </Target>

    <ItemGroup>
        <Reference Include="$(OutputAssemblyName)">
            <!-- For internal builds only -->
            <HintPath Condition=" '$(GenerateInterop)' != 'true' ">$(BinDir)$(TargetFrameworkVersion)\Raid.Interop.dll</HintPath>
            <HintPath Condition=" '$(GenerateInterop)' == 'true' ">$(IntermediateOutputPath)$(OutputAssemblyFile)</HintPath>
            <Private>False</Private>
            <SpecificVersion>False</SpecificVersion>
            <CopyLocal>False</CopyLocal>
        </Reference>
    </ItemGroup>

</Project>